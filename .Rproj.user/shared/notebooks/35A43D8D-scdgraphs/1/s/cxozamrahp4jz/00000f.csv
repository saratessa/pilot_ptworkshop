"0","# ------------------------------------------------------"
"0","# Setup"
"0","# ------------------------------------------------------"
"0","knitr::opts_chunk$set(fig.width = 10, fig.height = 6, dpi = 300, dev = ""png"")"
"0",""
"0","library(readr)"
"0","library(dplyr)"
"0","library(ggplot2)"
"0","library(janitor)"
"0","library(stringr)"
"0","library(scales)"
"0","library(grid)"
"0",""
"0","# Fonts (Times New Roman via showtext if available)"
"0","use_showtext <- requireNamespace(""showtext"", quietly = TRUE)"
"0","if (use_showtext) {"
"0","  library(showtext)"
"0","  showtext_auto(enable = TRUE)"
"0","  showtext_opts(dpi = 300)"
"0","}"
"0",""
"0","get_times_family <- function() {"
"0","  if (requireNamespace(""systemfonts"", quietly = TRUE)) {"
"0","    fi <- try(systemfonts::match_font(""Times New Roman""), silent = TRUE)"
"0","    if (!inherits(fi, ""try-error"") && !is.null(fi$family) && nchar(fi$family)) return(""Times New Roman"")"
"0","    fi2 <- try(systemfonts::match_font(""Times""), silent = TRUE)"
"0","    if (!inherits(fi2, ""try-error"") && !is.null(fi2$family) && nchar(fi2$family)) return(""Times"")"
"0","  }"
"0","  ""serif"""
"0","}"
"0","BASE_FAMILY <- get_times_family()"
"0","cat(""Using font family for plots:"", BASE_FAMILY, ""\n"")"
"1","Using font family for plots: serif 
"
"0","# ------------------------------------------------------"
"0","# Helpers"
"0","# ------------------------------------------------------"
"0","read_clean <- function(path) {"
"0","  read_csv(path, show_col_types = FALSE) |>"
"0","    clean_names() |>"
"0","    transmute("
"0","      participant = as.character(participant),"
"0","      week        = as.numeric(week),"
"0","      condition   = as.character(condition),"
"0","      outcome     = as.numeric(outcome)"
"0","    ) |>"
"0","    arrange(participant, week)"
"0","}"
"0",""
"0","# All phase changes (Baseline->Intervention bold; Intervention->Follow-up dashed)"
"0","phase_lines_all <- function(dat) {"
"0","  dat |>"
"0","    mutate(cond_low = str_to_lower(condition)) |>"
"0","    group_by(participant) |>"
"0","    arrange(week, .by_group = TRUE) |>"
"0","    mutate(prev_cond = lag(cond_low),"
"0","           prev_week = lag(week)) |>"
"0","    filter(!is.na(prev_cond) & cond_low != prev_cond) |>"
"0","    mutate("
"0","      xmid = prev_week + 0.5,"
"0","      type = case_when("
"0","        str_detect(cond_low, ""follow"") | str_detect(cond_low, ""maintain"") ~ ""followup"","
"0","        TRUE ~ ""intervention"""
"0","      )"
"0","    ) |>"
"0","    select(participant, xmid, type) |>"
"0","    ungroup()"
"0","}"
"0",""
"0","# Break only at condition changes (not at missing weeks)"
"0","add_segments_runs <- function(dat) {"
"0","  dat |>"
"0","    group_by(participant) |>"
"0","    arrange(week, .by_group = TRUE) |>"
"0","    mutate("
"0","      cond_lag = lag(condition, default = first(condition)),"
"0","      segment  = 1L + cumsum(condition != cond_lag)"
"0","    ) |>"
"0","    ungroup()"
"0","}"
"0",""
"0","# Plotter with fixed axes + TNR + padding"
"0","plot_mb_fixed <- function(dat, title, ylab,"
"0","                          x_limits, y_limits, y_breaks,"
"0","                          base_family = BASE_FAMILY) {"
"0","  dat <- dat |> filter(!is.na(outcome))"
"0","  vlines <- phase_lines_all(dat)"
"0","  dat    <- add_segments_runs(dat)"
"0",""
"0","  y0 <- y_limits[1]; y1 <- y_limits[2]"
"0",""
"0","  ggplot(dat, aes(week, outcome)) +"
"0","    geom_segment("
"0","      data = vlines |> filter(type == ""intervention""),"
"0","      aes(x = xmid, xend = xmid, y = y0, yend = y1),"
"0","      inherit.aes = FALSE, color = ""black"", linewidth = 1.2"
"0","    ) +"
"0","    geom_segment("
"0","      data = vlines |> filter(type == ""followup""),"
"0","      aes(x = xmid, xend = xmid, y = y0, yend = y1),"
"0","      inherit.aes = FALSE, color = ""black"", linewidth = 0.9, linetype = 2"
"0","    ) +"
"0","    geom_line(aes(group = interaction(participant, segment)),"
"0","              color = ""#E54E9A"", linewidth = 0.9, alpha = 0.9) +"
"0","    geom_point(shape = 21, size = 2.4, stroke = 0.7,"
"0","               color = ""#C2185B"", fill = ""#F7B6CC"") +"
"0","    facet_wrap(~ participant, ncol = 1, scales = ""fixed"") +"
"0","    scale_x_continuous("
"0","      limits = x_limits,"
"0","      breaks = seq(x_limits[1], x_limits[2], by = 1),"
"0","      expand = expansion(mult = c(0.01, 0.01))"
"0","    ) +"
"0","    scale_y_continuous("
"0","      limits = y_limits,"
"0","      breaks = y_breaks,"
"0","      expand = expansion(mult = c(0.02, 0.04))"
"0","    ) +"
"0","    labs(title = title, x = ""Week"", y = ylab) +"
"0","    theme_minimal(base_size = 13, base_family = base_family) +"
"0","    theme("
"0","      plot.title   = element_text(face = ""bold"", size = 18, hjust = 0.5),"
"0","      strip.text   = element_text(face = ""bold"", size = 12),"
"0","      axis.text.y  = element_text(size = 12, margin = margin(r = 8)),"
"0","      axis.text.x  = element_text(size = 12),"
"0","      axis.title.y = element_text(margin = margin(r = 12), size = 13),"
"0","      panel.grid.minor = element_blank(),"
"0","      panel.spacing.y  = unit(12, ""pt""),"
"0","      plot.margin = margin(t = 10, r = 20, b = 12, l = 38)"
"0","    ) +"
"0","    coord_cartesian(xlim = x_limits, ylim = y_limits, clip = ""off"")"
"0","}"
